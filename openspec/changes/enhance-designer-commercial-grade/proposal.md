# 提案：将流程设计器提升至商用级别

## Why

当前流程设计器具备基础功能，但缺少商用级产品必备的高级交互能力和用户体验优化。具体问题包括：

1. **连接线交互问题**：SVG 连接线拦截鼠标事件，导致节点无法点击选择
2. **连接线编辑能力不足**：无法重新调整连接线的路径、添加中间点或弯曲线条
3. **表单绑定功能缺失**：无法为整个流程配置绑定的业务表单
4. **撤销/重做未实现**：无法撤销误操作，影响用户体验
5. **节点删除功能不完善**：仅支持键盘删除，缺少右键菜单等直观操作
6. **连接线删除体验差**：需要先选中再删除，缺少一键删除功能
7. **画布交互体验待优化**：缺少网格吸附、多选、复制粘贴等专业功能
8. **性能优化不足**：大量节点时可能出现性能问题
9. **缺少数据持久化**：无法保存和加载流程定义
10. **缺少流程验证**：无法检测流程设计错误（如死循环、孤立节点等）

这些问题严重影响了产品的商业化能力和用户满意度。

## What Changes

### 核心功能增强
1. **连接线高级编辑**
   - 修复 SVG 层级问题，确保节点可正常点击
   - 支持贝塞尔曲线连接，提供美观的曲线效果
   - 支持连接线重绘：点击连接线可调整起点和终点
   - 支持连接线中间点编辑，创建更复杂的路径
   - 右键菜单支持删除连接线
   - 悬停时高亮显示连接线

2. **流程表单绑定**
   - 点击画布空白区域显示流程全局配置面板
   - 支持选择和绑定业务表单
   - 支持配置流程基本信息（名称、描述、分类）
   - 支持设置流程启动条件和权限

3. **撤销/重做系统**
   - 实现完整的历史记录栈
   - 支持 Ctrl+Z / Ctrl+Y 快捷键
   - 支持工具栏按钮操作
   - 记录所有编辑操作（添加、删除、移动、属性修改）

4. **增强的节点操作**
   - 右键菜单：删除、复制、属性
   - 多选节点：Ctrl+点击 或 框选
   - 批量操作：移动、删除、复制
   - 节点对齐辅助线
   - 网格吸附功能

5. **高级画布功能**
   - 小地图导航（缩略图）
   - 框选功能
   - 复制粘贴（Ctrl+C/V）
   - 全选（Ctrl+A）
   - 画布背景网格可配置

6. **数据管理**
   - 流程定义 JSON 序列化
   - 保存到本地存储
   - 导入导出流程定义
   - 自动保存草稿

7. **流程验证**
   - 实时验证流程完整性
   - 检测孤立节点
   - 检测可能的死循环
   - 验证必填属性
   - 显示验证错误提示

8. **性能优化**
   - 虚拟化渲染（节点数量超过 100 时）
   - 连接线路径缓存
   - 节点拖拽时的性能优化
   - 使用 requestAnimationFrame 优化动画

9. **用户体验优化**
   - 加载状态提示
   - 操作成功/失败反馈
   - 快捷键帮助面板
   - 工具提示
   - 上下文敏感的属性面板

10. **连接线样式定制**
    - 支持多种连接线类型（直线、折线、曲线）
    - 支持连接线标签
    - 支持条件分支的连接线样式
    - 支持连接线箭头样式定制

### 技术改进
- 引入状态管理（Pinia）管理设计器状态
- 实现命令模式支持撤销/重做
- 优化事件处理，使用事件委托
- 添加单元测试和集成测试
- 改进类型定义（准备 TypeScript 迁移）

## Impact

### 受影响的规格
- `specs/process-designer/spec.md` - 大量新需求和修改

### 受影响的代码
- `src/views/Designer.vue` - 主要修改文件，需要重构
- `src/stores/designer.js` - 新建：设计器状态管理
- `src/composables/useDesigner.js` - 新建：设计器逻辑组合函数
- `src/composables/useHistory.js` - 新建：撤销/重做逻辑
- `src/components/designer/` - 新建目录：设计器子组件
  - `CanvasNode.vue` - 画布节点组件
  - `ConnectionLine.vue` - 连接线组件
  - `PropertiesPanel.vue` - 属性面板组件
  - `Toolbox.vue` - 工具箱组件
  - `MiniMap.vue` - 小地图组件
  - `ContextMenu.vue` - 右键菜单组件
  - `ProcessConfigPanel.vue` - 流程配置面板组件

### 破坏性变更
- **无** - 纯功能增强，保持向后兼容

### 风险
- 重构可能引入新 bug，需要充分测试
- 性能优化需要在不同规模的流程下验证
- 状态管理引入可能增加学习成本

### 依赖
- 需要安装 `pinia` 用于状态管理
- 需要安装 `@vueuse/core` 用于组合函数工具

### 时间估算
- 开发时间：5-7 个工作日
- 测试时间：2-3 个工作日
- 总计：7-10 个工作日

